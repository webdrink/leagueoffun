name: üöÄ Deploy All Apps

on:
  push:
    branches: [main]
    paths:
      - 'apps/**'
      - 'packages/**'
      - '.github/workflows/deploy-all.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'deploy-all'
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  build:
    name: üèóÔ∏è Build All Apps
    runs-on: ubuntu-latest
    outputs:
      gamepicker-changed: ${{ steps.filter.outputs.gamepicker }}
      blamegame-changed: ${{ steps.filter.outputs.blamegame }}
      hookhunt-changed: ${{ steps.filter.outputs.hookhunt }}

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4

      - name: üîç Check Changed Paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            gamepicker:
              - 'apps/gamepicker/**'
              - 'packages/**'
            blamegame:
              - 'apps/blamegame/**'
              - 'packages/**'
            hookhunt:
              - 'apps/hookhunt/**'
              - 'packages/**'

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: üì• Install Dependencies
        run: |
          echo "üì• Installing dependencies..."
          if ! pnpm install --frozen-lockfile; then
            echo "‚ö†Ô∏è Lockfile mismatch, updating dependencies..."
            pnpm install --no-frozen-lockfile
          fi

      - name: üèóÔ∏è Build Gamepicker
        run: |
          echo "üèóÔ∏è Building Gamepicker..."
          pnpm --filter @leagueoffun/gamepicker build
          echo "‚úÖ Gamepicker build complete"

      - name: üèóÔ∏è Build Blamegame
        run: |
          echo "üèóÔ∏è Building Blamegame..."
          pnpm --filter @leagueoffun/blamegame build
          echo "‚úÖ Blamegame build complete"

      - name: üèóÔ∏è Build HookHunt
        run: |
          echo "üèóÔ∏è Building HookHunt..."
          pnpm --filter @leagueoffun/hookhunt build
          echo "‚úÖ HookHunt build complete"

      - name: üì§ Upload Gamepicker Artifact
        uses: actions/upload-artifact@v4
        with:
          name: gamepicker-dist
          path: apps/gamepicker/dist/
          retention-days: 1

      - name: üì§ Upload Blamegame Artifact
        uses: actions/upload-artifact@v4
        with:
          name: blamegame-dist
          path: apps/blamegame/dist/
          retention-days: 1

      - name: üì§ Upload HookHunt Artifact
        uses: actions/upload-artifact@v4
        with:
          name: hookhunt-dist
          path: apps/hookhunt/dist/
          retention-days: 1

  deploy-gamepicker:
    name: üéÆ Deploy Gamepicker (GitHub Pages)
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ‚¨áÔ∏è Download Gamepicker Artifact
        uses: actions/download-artifact@v4
        with:
          name: gamepicker-dist
          path: ./dist

      - name: üìù Add CNAME for Custom Domain
        run: |
          echo "www.leagueoffun.com" > ./dist/CNAME
          echo "üìù Added CNAME: www.leagueoffun.com"

      - name: üìù Add .nojekyll
        run: touch ./dist/.nojekyll

      - name: ‚öôÔ∏è Configure GitHub Pages
        uses: actions/configure-pages@v5

      - name: ‚¨ÜÔ∏è Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

      - name: üöÄ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ‚úÖ Gamepicker Deployment Complete
        run: |
          echo "‚úÖ Gamepicker deployed successfully!"
          echo "üåê URL: ${{ steps.deployment.outputs.page_url }}"

  deploy-blamegame:
    name: üéØ Deploy Blamegame
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Download Blamegame Artifact
        uses: actions/download-artifact@v4
        with:
          name: blamegame-dist
          path: ./blamegame-dist

      - name: ‚¨áÔ∏è Clone Target Repository
        run: |
          echo "üì• Cloning webdrink/blamegame..."
          git clone https://x-access-token:${{ secrets.DEPLOY_PAT }}@github.com/webdrink/blamegame.git deploy-blamegame
          echo "‚úÖ Repository cloned"

      - name: üöÄ Deploy to webdrink/blamegame
        run: |
          echo "üöÄ Deploying Blamegame to webdrink/blamegame..."
          
          cd deploy-blamegame
          
          # Preserve README.md if it exists
          if [ -f "README.md" ]; then
            cp README.md /tmp/README_blamegame_backup
            echo "üìù Preserved README.md"
          fi
          
          # Remove all files except .git
          find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} +
          
          # Copy new build files
          cp -r ../blamegame-dist/* .
          
          # Restore README.md
          if [ -f "/tmp/README_blamegame_backup" ]; then
            cp /tmp/README_blamegame_backup README.md
            echo "üìù Restored README.md"
          fi
          
          # Ensure CNAME file exists with correct domain
          echo "blamegame.leagueoffun.de" > CNAME
          echo "üìù Added CNAME: blamegame.leagueoffun.de"
          
          # Add .nojekyll file for GitHub Pages
          touch .nojekyll
          
          # Configure git
          git config user.name "leagueoffun-bot"
          git config user.email "ci@users.noreply.github.com"
          
          # Check for changes and commit
          git add -A
          if git diff --cached --quiet; then
            echo "‚úÖ No changes to deploy"
          else
            git commit -m "Deploy Blamegame - $(date +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "‚úÖ Blamegame deployment complete!"
          fi

      - name: ‚úÖ Blamegame Deployment Complete
        run: |
          echo "‚úÖ Blamegame deployed successfully!"
          echo "üåê URL: https://blamegame.leagueoffun.de"

  deploy-hookhunt:
    name: üéµ Deploy HookHunt
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Download HookHunt Artifact
        uses: actions/download-artifact@v4
        with:
          name: hookhunt-dist
          path: ./hookhunt-dist

      - name: ‚¨áÔ∏è Clone Target Repository
        run: |
          echo "üì• Cloning webdrink/HookHunt..."
          git clone https://x-access-token:${{ secrets.DEPLOY_PAT }}@github.com/webdrink/HookHunt.git deploy-hookhunt
          echo "‚úÖ Repository cloned"

      - name: üöÄ Deploy to webdrink/HookHunt
        run: |
          echo "üöÄ Deploying HookHunt to webdrink/HookHunt..."
          
          cd deploy-hookhunt
          
          # Preserve README.md if it exists
          if [ -f "README.md" ]; then
            cp README.md /tmp/README_hookhunt_backup
            echo "üìù Preserved README.md"
          fi
          
          # Remove all files except .git
          find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} +
          
          # Copy new build files
          cp -r ../hookhunt-dist/* .
          
          # Restore README.md
          if [ -f "/tmp/README_hookhunt_backup" ]; then
            cp /tmp/README_hookhunt_backup README.md
            echo "üìù Restored README.md"
          fi
          
          # Ensure CNAME file exists with correct domain
          echo "hookhunt.leagueoffun.com" > CNAME
          echo "üìù Added CNAME: hookhunt.leagueoffun.com"
          
          # Add .nojekyll file for GitHub Pages
          touch .nojekyll
          
          # Configure git
          git config user.name "leagueoffun-bot"
          git config user.email "ci@users.noreply.github.com"
          
          # Check for changes and commit
          git add -A
          if git diff --cached --quiet; then
            echo "‚úÖ No changes to deploy"
          else
            git commit -m "Deploy HookHunt - $(date +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "‚úÖ HookHunt deployment complete!"
          fi

      - name: ‚úÖ HookHunt Deployment Complete
        run: |
          echo "‚úÖ HookHunt deployed successfully!"
          echo "üåê URL: https://hookhunt.leagueoffun.com"

  summary:
    name: üìä Deployment Summary
    needs: [deploy-gamepicker, deploy-blamegame, deploy-hookhunt]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: üìä Generate Summary
        run: |
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| App | Status | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Gamepicker | ${{ needs.deploy-gamepicker.result == 'success' && '‚úÖ Success' || '‚ùå Failed' }} | https://www.leagueoffun.com |" >> $GITHUB_STEP_SUMMARY
          echo "| Blamegame | ${{ needs.deploy-blamegame.result == 'success' && '‚úÖ Success' || '‚ùå Failed' }} | https://blamegame.leagueoffun.de |" >> $GITHUB_STEP_SUMMARY
          echo "| HookHunt | ${{ needs.deploy-hookhunt.result == 'success' && '‚úÖ Success' || '‚ùå Failed' }} | https://hookhunt.leagueoffun.com |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: ‚ùå Fail if Any Deployment Failed
        if: needs.deploy-gamepicker.result != 'success' || needs.deploy-blamegame.result != 'success' || needs.deploy-hookhunt.result != 'success'
        run: |
          echo "‚ùå One or more deployments failed!"
          exit 1
